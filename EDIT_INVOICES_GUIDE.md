# دليل تعديل الفواتير

## نظرة عامة
تم إضافة وظيفة تعديل الفواتير لكل من المشتريات والمبيعات.

## الميزات المضافة

### 1. تعديل فواتير المشتريات
- **المسار**: `/purchases/edit/{id}`
- **الطريقة**: GET
- **الوظيفة**: عرض صفحة تعديل الفاتورة مع البيانات الحالية

### 2. تحديث فواتير المشتريات
- **المسار**: `/purchases/update/{id}`
- **الطريقة**: PUT
- **الوظيفة**: حفظ التعديلات على الفاتورة

### 3. تعديل فواتير المبيعات
- **المسار**: `/sales/edit/{id}`
- **الطريقة**: GET
- **الوظيفة**: عرض صفحة تعديل الفاتورة مع البيانات الحالية

### 4. تحديث فواتير المبيعات
- **المسار**: `/sales/update/{id}`
- **الطريقة**: PUT
- **الوظيفة**: حفظ التعديلات على الفاتورة

## كيفية الاستخدام

### من صفحة قائمة الفواتير:
1. افتح صفحة قائمة الفواتير (المشتريات أو المبيعات)
2. اضغط على زر "تعديل" (أيقونة القلم) بجانب الفاتورة المراد تعديلها
3. سيتم فتح صفحة التعديل مع جميع بيانات الفاتورة الحالية
4. قم بتعديل البيانات المطلوبة:
   - رأس الفاتورة (التاريخ، المورد/العميل، المخزن، إلخ)
   - الأصناف (إضافة، حذف، تعديل الكميات والأسعار)
   - الإجماليات والخصومات
5. اضغط على "حفظ" لحفظ التعديلات

## التغييرات التقنية

### الكنترولرات

#### PurchasesController
```php
// دالة عرض صفحة التعديل
public function edit($id)

// دالة تحديث الفاتورة
public function update(Request $request, $id)
```

#### SalesController
```php
// دالة عرض صفحة التعديل
public function edit($id)

// دالة تحديث الفاتورة
public function update(Request $request, $id)
```

### ملفات Blade

#### purchase.blade.php
- إضافة دعم متغير `$is_edit_mode`
- تحميل بيانات الفاتورة عند التعديل من `$invoice_data`
- تغيير action الفورم حسب الوضع (إضافة/تعديل)
- إضافة `@method('PUT')` عند التعديل

#### sales.blade.php
- نفس التعديلات المذكورة أعلاه

### آلية العمل

1. **عند التعديل**:
   - يتم جلب بيانات الفاتورة من جدول `ot_head`
   - يتم جلب تفاصيل الأصناف من جدول `fat_details`
   - يتم عرض البيانات في نفس صفحة الفاتورة

2. **عند الحفظ**:
   - يتم تحديث رأس الفاتورة في `ot_head`
   - يتم حذف التفاصيل القديمة (soft delete) من `fat_details`
   - يتم إضافة التفاصيل الجديدة
   - يتم تحديث كميات الأصناف في جدول `myitems`

## ملاحظات مهمة

1. **الحذف الناعم**: عند التعديل، لا يتم حذف التفاصيل القديمة نهائياً، بل يتم وضع علامة `isdeleted = 1`
2. **تحديث المخزون**: يتم تحديث كميات الأصناف تلقائياً بناءً على التعديلات
3. **الأصناف المتأثرة**: يتم تحديث جميع الأصناف التي كانت في الفاتورة القديمة والجديدة
4. **التحقق من البيانات**: يتم التحقق من وجود البيانات الأساسية (نوع الفاتورة، المخزن، المورد/العميل)

## الأخطاء المحتملة وحلولها

### خطأ: "الفاتورة غير موجودة"
- **السبب**: محاولة تعديل فاتورة محذوفة أو غير موجودة
- **الحل**: تأكد من رقم الفاتورة الصحيح

### خطأ: "البيانات الأساسية مطلوبة"
- **السبب**: عدم إدخال المورد/العميل أو المخزن
- **الحل**: تأكد من ملء جميع الحقول المطلوبة

### خطأ: "يجب إضافة صنف واحد على الأقل"
- **السبب**: محاولة حفظ فاتورة بدون أصناف
- **الحل**: أضف صنف واحد على الأقل

## الاختبار

للتأكد من عمل الوظيفة بشكل صحيح:

1. أنشئ فاتورة جديدة (مشتريات أو مبيعات)
2. افتح قائمة الفواتير
3. اضغط على زر "تعديل" للفاتورة المنشأة
4. قم بتعديل بعض البيانات
5. احفظ التعديلات
6. تحقق من أن التعديلات تم حفظها بنجاح
7. تحقق من تحديث كميات الأصناف في المخزون

## الدعم الفني

في حالة وجود أي مشاكل أو استفسارات، يرجى التواصل مع فريق التطوير.
